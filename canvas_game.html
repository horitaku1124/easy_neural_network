<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Game</title>
<script>
class DBSCANClustering {
    inputValues = [];
    minNumElements = 2;
    epsilon = 1.0;
    visitedPoints = new Set(); // should be Set
    metric = (a, b) => 0;

    constructor(inputValues, minNumElements, epsilon, metric) {
        this.inputValues = inputValues;
        this.minNumElements = minNumElements;
        this.epsilon = epsilon;
        this.metric = metric;
    }

    getNeighbours(verifyValues) {
        let neighbours = [];
        for (let candidate of this.inputValues) {
            if (this.metric(verifyValues, candidate) <= this.epsilon) {
                neighbours.push(candidate)
            }
        }
        return neighbours;
    }

    static mergeRightToLeftCollection(neighbours1, neighbours2) {
        for (let tempPt of neighbours2) {
            if (!neighbours1.contains(tempPt)) {
                neighbours1.push(tempPt);
            }
        }
        return neighbours1;
    }

    performClustering() {
        let resultList = [];
        this.visitedPoints.clear();

        let neighbours = [];
        let index = 0;
        while (this.inputValues.length > index) {
            let p = this.inputValues[index];
            if (!this.visitedPoints.has(p)) {
                this.visitedPoints.add(p);
                let neighbours = this.getNeighbours(p);

                if (neighbours.length >= this.minNumElements) {
                    let ind = 0;
                    while (neighbours.length > ind) {
                        let r = neighbours[ind];
                        if (!this.visitedPoints.has(r)) {
                            this.visitedPoints.add(r);
                            let individualNeighbours = this.getNeighbours(r);
                            if (individualNeighbours.length >= this.minNumElements) {
                                neighbours = DBSCANClustering.mergeRightToLeftCollection(
                                    neighbours, individualNeighbours)
                            }
                        }
                        ind++
                    }
                    resultList.push(neighbours)
                }
            }
            index++
        }
        return resultList;
    }
}
</script>
<script>
    let mainDisplay;
    let debugDisplay;
    document.addEventListener('DOMContentLoaded', () => {
        console.log("DOMContentLoaded", performance.now());
        mainDisplay = document.getElementById('main_display');
        debugDisplay = document.getElementById('debug_display');
        if (!mainDisplay || !mainDisplay.getContext) {
            throw Error('Context');
        }
        let ctx = mainDisplay.getContext('2d');
        ctx.beginPath();
        ctx.fillStyle = 'green';
        ctx.arc(70, 70, 30, 0, 2 * Math.PI, true);
        ctx.fill();

        console.log("paint done", performance.now());
        if (debugDisplay && debugDisplay.getContext) {
            let ctx2 = debugDisplay.getContext('2d');
            let imageData = ctx.getImageData(0, 0, mainDisplay.width, mainDisplay.height);
            let data = imageData.data;
            for (let i = 0; i < data.length; i += 4) {
                let avg = (data[i] + data[i +1] + data[i +2]) / 3;
                data[i]     = avg; // red
                data[i + 1] = avg; // green
                data[i + 2] = avg; // blue
            }
            for (let y = 0;y < mainDisplay.height - 1;y++) {
                let y0 = y * mainDisplay.width;
                for (let x = 0;x < mainDisplay.width - 1;x++) {
                    let xx = (y0 + x) * 4;
                    let xxx = (y0 + mainDisplay.width + x) * 4;
                    data[xx] = parseInt(Math.abs(
                        data[xx + 4] - data[xx] + data[xxx] - data[xx] + data[xxx + 4] - data[xx]
                    ));
                    data[xx + 1] = data[xx];
                    data[xx + 2] = data[xx + 1];
                    data[xx + 3] = 255;
                }
            }

            ctx2.putImageData(imageData, 0, 0);
        }
        console.log("putImageData done", performance.now());

    });
</script>
<style>
    canvas {
        border: 1px solid #aaa;
    }
</style>
</head>
<body>
<canvas id="main_display" width="400" height="300"></canvas><br><br>
<canvas id="debug_display" width="400" height="300"></canvas>
</body>
</html>